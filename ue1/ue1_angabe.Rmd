---
title: "MLE01 - Vertiefende statistische Verfahren"
subtitle: "1. Übungsblatt SS 2024"
author: "Stefan Kolb, Joachim Waltl"
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default 
---

# Allgemeine Information
Alle Aufgaben sind mit R zu lössen. Die Berechnungen sollen nachvollziehbar und dokumentiert sein. Um die vollständige Punktezahl zu erreichen, müssen alle Ergebnisse und Fragen entsprechend interpretiert bzw. beantwortet werden. Code alleine ist nicht ausreichend! Die Abgabe erfolgt über Moodle entsprechend der Abgaberichtlinien als pdf und Rmd File. Bitte inkludieren Sie namentlich alle beteiligten Gruppenmitglieder sowohl im Bericht als auch im Source Code.
Die jeweiligen Datensätze die für diese Übung relevant sind finden Sie ebenfalls in Moodle.

# 1 Lineare Regressionsanalyse [4P]
Für Menschen, die ihren Blutdruck senken wollen, ist eine häufig empfohlene Vorgehensweise, die Salzaufnahme zu senken. Sie möchten feststellen, ob es eine lineare Beziehung zwischen Salzaufnahme und Blutdruck gibt. Sie nehmen 52 Personen in die Stichprobe auf und messen deren diastolischen Blutdruck (in mmHg) und Natriumausscheidung (mmol/24h). [[ref](https://doi.org/10.1136/bmj.297.6644.319)]

**[2P] a:** Importieren Sie den Datensatz `intersalt.csv`. Erstellen Sie zwei Regressionsmodelle für den diastolische Blutdruck (bp) in Abhängigkeit der Natriumausscheidung (na). Das erste Modell soll alle Datenpunkte verwenden. Für das zweite Modell sollen die vier Datenpunkte mit der geringsten Natriumausscheidung aus dem Datensatz entfernt werden.

```{r}
# Daten einlesen
intersalt <- read.csv("intersalt.csv", sep = ";", dec = ",")

# Überblick über die Daten
str(intersalt)

# Umwandlung der Variablen vom Typ Character in numerische Variablen
intersalt$b <- as.numeric(intersalt$b)
intersalt$bp <- as.numeric(intersalt$bp)
intersalt$na <- as.numeric(intersalt$na)

# Erstes Modell (alle Datenpunkte)
model_1 <- lm(bp ~ na, data = intersalt)

# Datensatz nach Natriumausscheidung sortieren
intersalt_sorted <- intersalt[order(intersalt$na),]

# Enfernen der ersten vier Datenpunkte
intersalt_m2 <- intersalt_sorted[-c(1:4),]

# Zweites Modell
model_2 <- lm(bp ~ na, data = intersalt_m2)

```

Führen Sie für beide Modelle eine lineare Regressionsanalyse durch, die folgende Punkte umfasst:


i) Modellgleichung inklusive 95\% Konfidenzintervall der Modellparameter
i) Interpretation des Ergebnisses hinsichtlich Signifikanz und Modellgüte
i) Grafische Darstellung der Regressionsgeraden inkl. Konfidenzintervall


**Modell 1**
```{r}
# Zusammenfassung und KI-Intervall für model_1
summary(model_1)
confint(model_1)
```

Die Modellgleichung für das erste Modell lautet: bp = 67.56 [63.25;71.87] + 0.038 [0.01;0.07] * na. 

**Intercept:** Das 95\% Konfidenzintervall für den Intercept liegt zwischen 63.25123 und 71.87368. Das bedeutet, dass der diastolische Blutdruck bei einer Natriumausscheidung von 0 mmol/24h mit einer 95\%igen Sicherheit zwischen 63.25 und 71.87 mmHg liegt.

**Steigung:** Das 95\% Konfidenzintervall für die Steigung bezüglich der Natriumausscheidung liegt zwischen 0.00988 und 0.06548. Wir können also mit 95\%iger Sicherheit sagen, dass der Anstieg des diastolische Blutdruck zwischen 0.00988 und 0.06548 liegt, wenn die Natriumausscheidung um 1 mmol/24h steigt.

**Signifikanz und Modellgüte:** 
Die Signifikanz des p-Wertes für die Steigung (p = 0.0089) deutet auf einen statistisch signifikanten Zusammenhang zwischen der Natriumausscheidung und dem diastolischen Blutdruck hin. Der p-Wert für den Intercept dieses Modells ist sogar als hochsignifikant zu werten. Ein Wert von 0.1291 für das Bestimmtheitsmaß R^2 zeigt jedoch, dass das Modell nur etwa 12.91\% der Variabilität im diastolischen Blutdruck mit der Natriumausscheidung erklären kann. Die Erkenntnis daraus ist, dass noch andere Faktor den Blutdruck beeinflussen. 


i) Grafische Darstellung der Regressionsgeraden inkl. Konfidenzintervall

```{r}
# Grafische Darstellung der Regressionsgeraden inkl. Konfidenzintervall für model_1
library(ggplot2)
ggplot(intersalt, aes(x = na, y = bp)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  labs(title = "Diastolischer Blutdruck in Abhängigkeit der Natriumausscheidung",
       x = "Natriumausscheidung (mmol/24h)",
       y = "Diastolischer Blutdruck (mmHg)")

```


```{r}  
# Zusammenfassung und KI-Intervall für model_2
summary(model_2)
confint(model_2)

```

Die Modellgleichung für das zweite Modell lautet: bp = 81.06 [74.40;87.72] - 0.045 [-0.09;0.00] * na.

**Intercept:** Das 95% Konfidenzintervall für den Intercept liegt zwischen 74.40191 und 
87.72479. Das bedeutet, dass der diastolische Blutdruck laut diesem Modell bei einer Natriumausscheidung von 0 mmol/24h mit einer 95%igen Sicherheit zwischen 74.40 und 87.72 mmHg liegt.

**Steigung:** Das 95% Konfidenzintervall für die Steigung bezüglich der Natriumausscheidung liegt zwischen -0.08602 und -0.00337. In diesem Fall ist also von einer Abnahme des diastolischen Blutdrucks um 0.00337 bis 0.08602 mmHg auszugehen, wenn die Natriumausscheidung um 1 mmol/24h steigt. Im Gegensatz zum ersten Modell zeigt die Steigung hier also einen negativen Zusammenhang zwischen Natriumausscheidung und diastolischem Blutdruck.  

**Signifikanz und Modellgüte:** Auch bei diesem Modell ist der p-Wert für den Intercept hochsignifikant. Der p-Wert für die Steigung ist mit 0.035 zwar signifikant, aber deutlich weniger als der p-Wert für die Steigung des ersten Modells. Das Bestimmtheitsmaß R^2 beträgt hier 0.09, was bedeutet, dass das Modell nur etwa 9% der Variabilität im diastolischen Blutdruck mit der Natriumausscheidung erklären kann, wobei es beim ersten Modell noch knapp 13% waren.

i) Grafische Darstellung der Regressionsgeraden inkl. Konfidenzintervall

```{r}
# Grafische Darstellung der Regressionsgeraden inkl. Konfidenzintervall für model_2
ggplot(intersalt_m2, aes(x = na, y = bp)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  labs(title = "Diastolischer Blutdruck in Abhängigkeit der Natriumausscheidung (reduzierte Daten)",
       x = "Natriumausscheidung (mmol/24h)",
       y = "Diastolischer Blutdruck (mmHg)")
```

Vergleichen Sie beide Modelle. Was können Sie beobachten

Die signifikante Änderung der Richtung des Effekts (von positiv zu negativ) nach dem Entfernen der vier Datenpunkte mit der niedrigsten Natriumausscheidung legt nahe, dass diese Datenpunkte einen erheblichen Einfluss auf das Gesamtergebnis des Modells haben.

Ein niedrigerer Wert für R^2 im zweiten Modell könnte bedeuten, dass die vier entfernten Datenpunkte tatsächlich einen wichtigen Beitrag zur Erklärung der Variabilität des diastolischen Blutdrucks leisten.

Trotz der signifikanten Koeffizienten in beiden Modellen bleiben die R^2 Werte relativ niedrig. Somit wird deutlich, dass noch weitere, hier nicht betrachtete Variablen einen Einfluss auf den diastolischen Blutdruck haben.


**[2P] b:** Lesen Sie den Artikel "The (Political) Science of Salt" und vergleichen Sie damit Ihre Beobachtungen. Gibt es Faktoren die in Ihren Modellen eventuell nicht berücksichtigt wurden? Wie lautet die Schlussfolgerung - führt eine Reduktion der Salzaufnahme zu einer Blutdrucksenkung? 

Modellierung der Daten: Obwohl das lineare Modell signifikante Zusammenhänge zwischen Natriumaufnahme und Blutdruck gefunden hat, legen die Ergebnisse nahe, dass der Zusammenhang komplex ist und möglicherweise von weiteren Faktoren beeinflusst wird, die in einfacheren Modellen nicht berücksichtigt werden.
Schlussfolgerung hinsichtlich Salzaufnahme und Blutdrucksenkung: Die Studie legt nahe, dass eine Reduktion der Salzaufnahme zu einer Senkung des Blutdrucks führen kann, besonders über längere Zeiträume und Lebensspannen hinweg betrachtet. Allerdings scheint der Effekt von der Höhe der Salzaufnahme und von anderen Variablen beeinflusst zu werden.


# 2 Lineare Regressionsanalyse (kategorisch) [3P]
Der Datensatz `infant.csv` enthält Information über die unterschiedliche Kindersterblichkeit zwischen den Kontinenten. Die Variable `infant` enthält die Kindersterblichkeit in Tode pro 1000 Geburten. Unterscheidet sich die Kindersterblichkeit zwischen den Kontinenten?

**[2P] a:** Führen Sie eine Regressionsanalyse mit Europa als Referenz durch, welche die folgenden Punkte umfasst:

i) Modellgleichung inklusive 95\% Konfidenzintervall der Modellparameter
i) Interpretation des Ergebnisses hinsichtlich Signifikanz
i) Beurteilung der Modellgüte und Residuenanalyse

```{r}
# Import the data
data <- read.csv2("infant.csv")

# Convert the region variable to a factor
data$region <- as.factor(data$region)

# Set "Europe" as the reference level for the region variable
data$region <- relevel(data$region, ref = "Europe")

# Fit a linear model with infant as a function of region only
model <- lm(infant ~ region, data = data)

# Print the model equation and 95% confidence intervals
summary(model)
confint(model, level=0.95)
```
Der p-WErt der F-Stastik liegt unter 5%&, was bedeuet, dass mindestens ein
Koeffizient signifikant ist.

Der p-Wert der erwarteten Kindersterblichkeit für Europa "(Intercept)" liegt
mit 31% über dem Signifikanzniveau von 5%. Dementsprechend ist 0 im
Konfidenzintervall eingeschlossen. D.h. es gibt keinen signfikanten Unterschied 
zu Kindersterblichkeit gleich 0.

Der p-Wert der erwarteten Differenz in der Kindersterblichkeit zwischen Europa
und Amerika "regionAmericas" liegt auch über 5%. D.h. es gibt keinen signifikanten
Unterschied in der Kindeersterblichkeit zwischen Euorpa und Amerika.

Die p-Werte der erwareten Differenzen in der Kindersterblichkeit zwischen den
übrigen Regionen und Europa liegen unter 5%. D.h. es gibt einen signfikanten
Unterschied in der Kindersterblichkeit zu Europa.

Der adjusted R^2 beträgt 23%. D.h. 23% der Varianz in der (relativen)
Kindersterblichkeit können durch eine Änderung in den (binären)
Prädiktor-Variablen bestimmt werden.


```{r}
# Interpret the significance of the results
# The p-value for each term tests the null hypothesis that the coefficient is equal to zero (no effect).
# A low p-value (< 0.05) indicates that you can reject the null hypothesis.

# Assess the quality of the model and perform a residual analysis
#par(mfrow=c(2,2))
#plot(model)


# Convert model's data to a data frame
model_data <- data[complete.cases(data), ]  # remove rows with missing values
df <- data.frame(resid = resid(model), fitted = fitted(model),
                 region = model_data$region, infant = model_data$infant)

# Load ggplot2
library(ggplot2)

# Create the four diagnostic plots
# 1. Residuals vs Fitted
p1 <- ggplot(df, aes(fitted, resid)) +
  geom_point() +
  #geom_smooth(se = FALSE) +
  ggtitle("1.) Residuum vs Vorhergesagter Wert")

# 2. Normal Q-Q
p2 <- ggplot(df, aes(sample = resid)) +
  stat_qq() +
  stat_qq_line(colour = "red") +
  ggtitle("2.) Normal Q-Q-Plot")

# 3. Histogram of residuals
p3 <- ggplot(df, aes(x=resid)) +
  geom_histogram(binwidth = 10) +
  ggtitle("3.) Histogramm der Residuen")

# 4. Scatter Plot
p4 <- ggplot(df, aes(x=region, y=infant)) +
  geom_jitter(width=0.0) +
  ggtitle("Streudiagramm der Kindersterblichkeit nach Region")

# Load gridExtra
library(gridExtra)

# Arrange the plots in a 4x1 grid
grid.arrange(p1, p2, p3, p4, nrow = 2)



```
Die Region Asien zeigt 3 Ausreißer nach oben, die besonders ins Auge stechen.
Wenn man sie ignoriert, kann man eine annährende Normalverteilung der Residuen
beispielsweise im Q-Q-Plot und Histogramm erkennen.

Links oben: Die Residuen streuen normalverteilt um den Nullpunkt, allerdings
scheint die Standardabweichung der Residuen nach Region unterschiedlich zu sein.

Insgesamt entsteht aber der Eindruck, dass eine Normalverteilung der Residuen
vorliegt und ihre Varianz in etwa gleich bleibt
(d.h. Homoskedastizität gegeben ist). 
```{r}
#installed_packages <- installed.packages()
#print(installed_packages)
```

**[1P] b:** Wie hoch ist die Kindersterblichkeit in Europa und wie hoch in Afrika (inkl. Unsicherheit)?

```{r}
# Get the model coefficients and their confidence intervals
coef <- coef(model)
conf_int <- confint(model)
names(coef(model))

# Calculate the infant mortality rate for Europe
europe_coef <- coef["(Intercept)"]
europe_conf_int <- conf_int["(Intercept)", ]

# Calculate the infant mortality rate for Africa
africa_coef <- coef["regionAfrica"]
africa_conf_int <- conf_int["regionAfrica", ]

# Print the results
cat("Europa:\n")
cat("Anzahl: ", europe_coef, "\n")
cat("95% KI: ", europe_conf_int, "\n")

cat("Afrika:\n")
cat("Anzahl: ", africa_coef, "\n")
cat("95% KI: ", africa_conf_int, "\n")
```

# 3 Regressionsanalyse [3P]
Die Daten `wtloss.xlsx` enthalten den Gewichtsverlauf eines adipösen Patienten im Zuge einer Diät. Sie als betreuender Mediziner und passionierter Freizeit Data Scientist möchten ein geeignetes Regressionsmodell erstellen, um den Verlauf der Diät besser steuern zu können. Das ideale Zielgewicht bezogen auf die Größe des Patienten wäre bei 80 kg. Importieren Sie den Datensatz mit Hilfe der `read_excel()` Funktion aus dem `library(readxl)` Paket. 

**[2P] a:** Die Regressionsanalyse sollte folgende Punkte inkludieren:

i) Modellgleichung inklusive 95% Konfidenzintervall der Modellparameter
i) Interpretation des Ergebnisses hinsichtlich Signifikanz
i) Beurteilung der Modellgüte und Residuenanalyse
i) Grafische Darstellung der Regressionsgeraden inkl. Konfidenz-und Vorhersageintervall

**[1P] b:** Welches Gewicht hat der Patient nach 30 Tagen bzw. nach 200 Tagen Diät?

# 4 Multiple Regressionsanalyse [3P]
Die Framingham-Herz-Studie war ein Wendepunkt bei der Identifizierung von Risikofaktoren für koronare Herzkrankheiten und ist eine der wichtigsten epidemiologischen Studien die je durchgeführt wurden. Ein großer Teil unseres heutigen Verständnisses von Herz-Kreislauf-Erkrankungen ist auf diese Studie zurückzuführen. Der Datensatz `Framingham.sav` enthält Varibalen hinsichtlich Demographie, Verhaltensweise, Krankengeschichte und Risikofaktoren. Finden Sie ein geeignetes Modell, dass den systolischen Blutdruck (`sysbp`) beschreibt. Vermeiden Sie nicht relevante bzw. redundante Variablen (z.B. "Incident" Variablen). Achten Sie auf Ausreißer und fehlende Daten (`NaN, NA's`). 
 
**[2P] a:** Die Regressionsanalyse sollte folgende Punkte inkludieren:

i) Modellgleichung inklusive 95% Konfidenzintervall der Modellparameter
i) Interpretation des Ergebnisses hinsichtlich Signifikanz
i) Beurteilung der Modellgüte und Residuenanalyse

**[1P] b:** Welchen systolischen Blutdruck hat eine Person mit folgendem Profil:

Frau, 50 Jahre, High School, Raucher, 8 Zig/Tag, keine Blutdruck senkenden Medikamente, 220 mg/dl Serum Cholesterol, 85 mmHg diastolischer Blutdruck, BMI von 30, kein Diabetes, 90 bpm Herzrate und Glukoselevel von 90 mg/dl.


