---
title: "Vertiefende statistische Verfahren"
subtitle: "3. Übungsblatt SS 2024"
author: "Stefan Kolb, Joachim Waltl"
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
---

```{r setup, include=FALSE}
## Run this chunk ALWAYS first !
# Arbeitsverzeichnis für VSC Nutzer korrekt setzen
# Nötige Packages installieren und laden
# Helfer Funktionen für alle Nutzer laden

# Set relative path to target working directory
rel_path_to_target_dir <- "ue3"
# Helper file name
rel_path_from_target_dir_to_helper_file <- "helper.R"

# Check if the code is run in RStudio
checkIDEisRStudio <- function() {
  isRStudio <- Sys.getenv("RSTUDIO") == "1"
  if (isRStudio) {
    return(TRUE)
  } else {
    return(FALSE)
  }
}

# The working directory is only changed if the code is NOT run in RStudio
if (!checkIDEisRStudio()) {
  # Change relative path accordingly to your target working directory
  abs_path_to_target_dir <- file.path(getwd(),rel_path_to_target_dir)
  # Check if target directory exists
  if(dir.exists(abs_path_to_target_dir)){
    setwd(abs_path_to_target_dir)
  }
}

# Check whether package is already installed, if not install it
load <- function(package_name) {
  if (length(find.package(package_name, quiet = TRUE)) == 0) {
    # Set the CRAN mirror
    options(repos = c(CRAN = "https://cran.wu.ac.at/"))
    install.packages(package_name)
  }
  suppressWarnings(library(package_name, character.only = TRUE))
}

# Load packages
load("pROC")
load("caret")
load("ResourceSelection")
load("foreign")
load("haven")
load("tidyverse")
load("car")
load("ggplot2")
load("stats")
load("ROCit")
load("ggpubr")
load("nparLD")
load("rcompanion")
load("FSA")




# Function to source helper file
load_source <- function() {
    if(!checkIDEisRStudio()){
      if(file.exists(rel_path_from_target_dir_to_helper_file)){
        source(rel_path_from_target_dir_to_helper_file)
      }
    } else {
      helper_file <- basename(rel_path_from_target_dir_to_helper_file)
      if(file.exists(helper_file)){
        source(helper_file)
      }
  }
}
# Apply function to source helper file
load_source()


```

# Allgemeine Information
Alle Aufgaben sind mit R zu lössen, wenn nicht explizit anders angegeben. Die Berechnungen sollen nachvollziehbar und dokumentiert sein. Um die vollständige Punktezahl zu erreichen, müssen alle Ergebnisse und Fragen entsprechend interpretiert bzw. beantwortet werden. Code alleine ist nicht ausreichend! Die Abgabe erfolgt über Moodle entsprechend der Abgaberichtlinien als pdf und Rmd File. Bitte inkludieren Sie namentlich alle beteiligten Gruppenmitglieder sowohl im Bericht als auch im Source Code.
Die jeweiligen Datensätze die für diese Übung relevant sind finden Sie ebenfalls in Moodle.

# 1 Einfaktorielle ANOVA (händisch) [2P]
Ein Sportwissenschafter möchte sehen, ob es einen Unterschied in der Gewichtszunahme von Sportlern gibt, die einer von drei speziellen Diäten folgen. Die Athleten werden nach dem Zufallsprinzip drei Gruppen zugewiesen und unterziehen sich für 6 Wochen der jeweiligen Diät. Die Gewichtszunahmen (in Pfund) sind angegeben. Nehmen Sie an, dass die Gewichtszunahmen normalverteilt sind und die Varianzen gleich sind. Kann der Sportwissenschafter bei einem Signifikanzniveau von 0,05 schlussfolgern, dass es einen Unterschied zwischen den Diäten gibt? Führen Sie die ANOVA händisch durch und überprüfen Sie das Ergebnis mit `summary(aov(...))`.

Diät   | Messwerte
-------| -------------
A      | 3, 6, 7, 4       
B      | 10, 12, 11, 14, 8, 6
C      | 8, 3, 2, 5

```{r}
# Einlesen der Daten
gains <- list(
  A = c(3, 6, 7, 4),
  B = c(10, 12, 11, 14, 8, 6),
  C = c(8, 3, 2, 5))

# Überblick über die Daten / Farben nach Diet
str(gains)
boxplot(gains, col = c("red", "green", "blue"), 
        ylab = "Gewichtszunahmen",
        xlab = "Diät",
        main = "Gewichtszunahmen nach Diät")

# Hypothesen
# H0: mu_a = mu_b = mu_c
# H1: mu_i != mu_j (für mindestens ein Paar i,j)

# Berechnung des Gesamt-Mittelwertes
mean_total = mean(unlist(gains))

# Berechnung der Quadratsummen
qs_between <- 0
for (group in gains) {
  group_mean <- mean(group)
  n <- length(group)
  qs_between <- qs_between + n * (group_mean - mean_total)^2
}

paste("Die Quadratsumme zwischen den Gruppen beträgt: ", round(qs_between,2))

qs_within <- 0
for (group in gains) {
  group_mean <- mean(group)
  for (value in group) {
    qs_within <- qs_within + (value - group_mean)^2
  }
}

paste("Die Quadratsumme innerhalb der Gruppen beträgt: ", round(qs_within,2))

qs_total <- sum((unlist(gains) - mean_total)^2)

paste("Die Quadratsumme insgesamt beträgt: ", round(qs_total,2))

# Prüfung der Quadratsummen
round(qs_total, 2)==round(qs_between + qs_within, 2)

# Überprüfen der Vorraussetzungen

# Normalverteilung
for (group in gains) {
  print(shapiro.test(group))
}

# Varianzhomogenität (Barlet-Test)
bartlett.test(gains)

# Freiheitsgrade
df_between <- length(gains) - 1
df_within <- length(unlist(gains)) - length(gains)
df_total <- length(unlist(gains)) - 1

# Berechnung der Varianzen (Mittlere Quadratsummen)
ms_total <- qs_total / df_total
ms_between <- qs_between / df_between
ms_within <- qs_within / df_within

# Berechnung des F-Wertes
f_value <- ms_between / ms_within
paste("Der F-Wert beträgt: ", round(f_value, 2))

# kritischer F-Wert aus Tabelle
alpha <- 0.05
f_critical <- qf(alpha, df_between, df_within,lower.tail = F)
paste("Der kritische F-Wert beträgt: ", round(f_critical, 2))

# Ergebnis
if (f_value > f_critical) {
  print("H0 wird verworfen")
} else {
  print("H0 wird nicht verworfen")
}

# p-Wert
p_value <- pf(f_value, df_between, df_within, lower.tail = F)
paste("Der berechnete p-Wert beträgt: ", round(p_value,5))

# Überprüfung mit R
diet <- factor(rep(names(gains), times = sapply(gains, length)))
all_gains <- unlist(gains)

aov_result <- aov(all_gains ~ diet)
summary(aov_result)
```

Interpretation: In diesem Fall gibt es einen signifikanten Einfluss des Faktors Diät [F(2,11) = 7.74; p < 0.05] auf die Gewichtszunahme der Sportler. Die Ergebnisse der manuellen Berechnung, stimmen mit den Ergebnissen der ANOVA-Analyse in R überein.

# 2 Einfaktorielle ANOVA [2P]
Analysieren Sie die Daten zu niedrigem Geburtsgewicht von Neugeborenen in `birthwt_aov.xlsx`. Untersuchen Sie ob die ethnische Zugehörigkeit der Mutter (Variable `ethnic`, wobei `1 = "white"`, `2 = "black"`, `3 = "other"` ) einen Einfluss auf das Geburtsgewicht von Neugeborenen hat (Variable `bwt`). Beachten Sie dabei folgende Punkte:

i) Überprüfen Sie die Vorraussetzungen.
i) Verwenden Sie eine geeignete grafische Darstellung der Daten / Ergebnisse.
i) Gibt es signifikante Unterschiede zwischen den Gruppen, wenn ja zwischen welchen Gruppen?
i) Achten Sie auf eine "statistisch korrekte" Formulierung des Ergebnisses.

```{r}
# Daten einlesen
library(readxl)
birthwt <- read_excel("UE3 Daten/birthwt_aov.xlsx")

# Faktor für ethnische Zugehörigkeit
birthwt$ethnic <- factor(birthwt$ethnic, levels = c(1,2,3), labels = c("white", "black", "other"))

# Überblick über die Daten
str(birthwt)
table(birthwt$ethnic)
summary(birthwt$bwt)

# Hypothesen
# H0: mu_white = mu_black = mu_other
# H1: mu_i != mu_j (für mindestens ein Paar i,j)

# Überprüfen der Vorraussetzungen

# Vergleich der Gruppengrößen
max(table(birthwt$ethnic))/min(table(birthwt$ethnic)) < 1.5

# Normalverteilung (für jede Gruppe)
par(mfrow = c(1,3))
hist(birthwt$bwt[birthwt$ethnic == 'white'], main = "ethnic 1 (white)")
hist(birthwt$bwt[birthwt$ethnic == 'black'], main = "ethnic 2 (black)")
hist(birthwt$bwt[birthwt$ethnic == 'other'], main = "ethnic 3 (other)")

ethnics <- unique(birthwt$ethnic)
# Shapiro-Wilk-Test
for (ethnic in ethnics) {
  print(shapiro.test(birthwt$bwt[birthwt$ethnic == ethnic]))
}

```
Ein visuelle Überprüfung der Normalverteilung zeigt, dass diese für alle Gruppen gegeben ist. Der Shapiro-Wilk-Test bestätigt diese Annahme, weshalb die Annahme einer Normalverteilung der Residien erfüllt ist.
Ein Vergleich der Gruppengrößen zeigt, dass die Gruppen unterschiedlich groß sind, da der Quotien aus der größten und kleinsten Gruppengröße größer als 1.5 ist. Das ist jedoch kein großes Problem, da die ANOVA robust gegenüber unterschiedlichen Gruppengrößen ist, insofern die Varianzhomogenität nicht verletzt wird [Wikipedia](https://de.wikipedia.org/wiki/Varianzanalyse#:~:text=Inhomogene%20Varianzen%20stellen%20bei%20ungleichen%20Gruppengr%C3%B6%C3%9Fen%20ein%20Problem%20dar). 

```{r, warning=FALSE, message=FALSE}
# Varianzhomogenität (Heteroskedastizität)

# Levene-Test
library(car)
leveneTest(bwt ~ ethnic, data = birthwt)

# Bartlett-Test
bartlett.test(birthwt$bwt ~ birthwt$ethnic)

```
Sowohl der Levene- als auch der Bartlett-Test zeigen, dass die Varianzhomogenität gegeben ist. 

Alle wesentlichen Vorraussetzungen für die ANOVA sind somit gegeben und sie kann ohne Bedenken durchgeführt werden.

```{r}
# ANOVA
aov_result <- aov(bwt ~ ethnic, data = birthwt)
summary(aov_result)

# Darstellung der Ergebnisse
library(ggplot2)
ggplot(birthwt, aes(x = ethnic, y = bwt)) +
  geom_boxplot() +
  labs(title = "Geburtsgewicht in Abhängigkeit der ethnischen Zugehörigkeit",
       x = "ethnische Zugehörigkeit",
       y = "Geburtsgewicht")

```
Die ethnische Zugehörigkeit hat einen signifikanten Einfluss auf das Geburtsgewicht von Neugeborenen, F(2,186) = 4.91, p = 0.008.

Um herauszufinden zwischen welchen Gruppen signifikante Unterschiede bestehen, wird nun eine Post-Hoc-Analyse durchgeführt. Als geeigneter Test wird der Tukey HSD-Test verwendet.

```{r, warning=FALSE, message=FALSE}
# Post-Hoc-Test
pht <- TukeyHSD(aov_result)
print(pht)

# Darstellung der Ergebnisse
library(ggpubr)

stat.test <- tibble::tribble(
  ~group1, ~group2,   ~p.adj,
  "white",     "black", round(pht$ethnic[1,4],6),
  "white",     "other", round(pht$ethnic[2,4],6),
  "black",     "other", round(pht$ethnic[3,4],6))

# Boxplots (inkl. p-Werte)
ggboxplot(birthwt, x = "ethnic", y = "bwt",
          fill = "ethnic", 
          palette = "jco",
          ylab = "birthweight") +
  stat_pvalue_manual(stat.test,
                     y.position = 5500, step.increase = 0.2,
                     label = "p.adj")
```
Der Tukey HSD-Test zeigt, dass es signifikante Unterschiede zwischen den ethnischen Gruppen "white" und "black" (p = 0.043) sowie "white" und "other" (p = 0.026) gibt. Zwischen den Gruppen "black" und "other" besteht hingegen kein signifikanter Unterschied (p = 0.862). Konkret wiegen schwarze Neugeborene durchschnittlich 383,03 Gramm weniger als weiße. Neugeborene aus anderen ethnischen Gruppen weisen ebenfalls ein signifikant geringeres Geburtsgewicht auf als weiße Neugeborene, mit einem durchschnittlichen Unterschied von 297,44 Gramm. Im Vergleich zwischen schwarzen und anderen ethnischen Gruppen gibt es jedoch keinen signifikanten Unterschied im Geburtsgewicht, wie die Analyse mit einem p-Wert von 0,8624 zeigt.

# 3 Einfaktorielle ANOVA [2P]

Verwenden Sie den bereits bekannten `Framingham.sav` Datensatz. Analysieren Sie ob es Unterschiede im BMI in Abhängigkeit von der Schulbildung gibt. Achten Sie auf Ausreißer und fehlende Daten (`NaN, NA's`).

i) Überprüfen Sie die Vorraussetzungen.

```{r}
load_source()

# Load and clean data. Handle factor variables
framingham <- load_and_prepare_framingham("UE3 Daten/Framingham.sav")

# Check requirements for ANOVA

# -- For education levels

test_normality_of_groups(framingham, "educ", "bmi")
```
```{r}
# Variance inhomogeneity (Heteroscedasticity)

# Levene test
leveneTest(bmi ~ educ, data = framingham)

# Bartlett test
bartlett.test(bmi ~ educ, data = framingham)
```

Die Histogramme der BMI-Werte für die verschiedenen Bildungsstufen zeigen, dass die Verteilung der BMI-Werte für jede Bildungsstufe keiner Normalverteilung folgt.
Der Shapiro-Wilk-Test bestätigt diese Annahme, da die p-Werte für alle Bildungsstufen kleiner als 0,05 sind.
Außerdem zeigt der Levene Test, dass die Varianz aller Gruppen nicht gleich ist.
Daher sind die Voraussetzunge einer ANOVA verletzt. Allerdings reagiert der F-Test auf Abweichungen nicht so empfindlich, wenn
1) die Gruppengrößen etwa gleich sind
2) und die Gruppen hinreichend groß sind.

```{r}
table(framingham$educ)
```

Da Bedinung 1 nicht erfüllt ist, muss von einer ANOVA abgesehen werden. Stattdessen wird ein Kruskal Wallis Test angewandt.

i) Verwenden Sie eine geeignete grafische Darstellung der Daten / Ergebnisse.

```{r}
# Boxplot education levels
ggplot(framingham, aes(x = educ, y = bmi)) +
  geom_boxplot() +
  labs(title = "BMI in Abhängigkeit des Bildungsgrades",
       x = "Bildungsgrad",
       y = "BMI in kg/m^2")

# Remove outliers (median +- 1.5 IQR)
library(dplyr)
framingham_clean <- framingham %>%
  group_by(educ) %>%
  mutate(lower_bound = quantile(bmi, 0.25) - 1.5 * IQR(bmi),
         upper_bound = quantile(bmi, 0.75) + 1.5 * IQR(bmi)) %>%
  filter(bmi >= lower_bound & bmi <= upper_bound)

# Boxplot education levels without outliers
ggplot(framingham_clean, aes(x = educ, y = bmi)) +
  geom_boxplot() +
  labs(title = "BMI in Abhängigkeit des Bildungsgrades",
       x = "Bildungsgrad",
       y = "BMI in kg/m^2")
```
Die Boxplots legen die Vermutung nahe, dass zumindest der Unterschieder zwischen Gruppe "Bildungsgrad 1" und den anderen Gruppen signfikant ist.


i) Gibt es signifikante Unterschiede zwischen den Bildungsstufen, wenn ja zwischen welchen Stufen?


```{r}
# RESULTS NOT VALID! REQUIREMENTS NOT MET!

# # ANOVA
# aov_result <- aov(bmi ~ educ, data = framingham)
# summary(aov_result)

# # Show results
# library(ggplot2)
# ggplot(framingham, aes(x = educ, y = bmi)) +
#   geom_boxplot() +
#   labs(title = "BMI in Abhängigkeit des Bildungsgrades",
#        x = "Bildungsgrad",
#        y = "BMI in kg/m^2")
```

```{r}
# RESULTS NOT VALID! REQUIREMENTS NOT MET!

# # Post hoc analysis
# pht <- TukeyHSD(aov_result)
# print(pht)

# # Show results
# library(ggpubr)

# stat.test <- tibble::tribble(
#   ~group1, ~group2,   ~p.adj,
#   "1",     "2", round(pht$educ[1,4],6),
#   "1",     "3", round(pht$educ[2,4],6),
#   "1",     "4", round(pht$educ[3,4],6),
#   "2",     "3", round(pht$educ[4,4],6),
#   "2",     "4", round(pht$educ[5,4],6),
#   "3",     "4", round(pht$educ[6,4],6))

# # Determine the maximum value of the 'bmi' column
# max_bmi <- max(framingham$bmi, na.rm = TRUE)

# # Create an array of y positions starting from the maximum BMI value and incrementing by a small amount
# y_positions <- max_bmi + seq(from = 1, to = 6, by = 1)

# # Create boxplot
# ggboxplot(framingham, x = "educ", y = "bmi",
#           color = "educ", 
#           palette = "jco") +
#   stat_pvalue_manual(stat.test,
#                      y.position = y_positions, 
#                      step.increase = 0.2,
#                      label = "p.adj")
```

```{r}
# Kruskal Wallis Test
# Non parametric test instead of one way ANOVA

kwt_result <- kruskal.test(bmi ~ educ, data = framingham)
kwt_result

# Show results
library(ggplot2)
ggplot(framingham, aes(x = educ, y = bmi)) +
  geom_boxplot() +
  labs(title = "BMI in Abhängigkeit des Bildungsgrades",
       x = "Bildungsgrad",
       y = "BMI in kg/m^2")

```

Da der p-Wert kleiner als 0.05 ist, kann angenommen werden, dass es einen signifikanten Unterschied zwischen den Bildungsstufen gibt.

```{r}
# Post hoc test

# Perform pairwise Wilcoxon test
pwt_result <- pairwise.wilcox.test(framingham$bmi, framingham$educ, p.adjust.method = "BH")

# Extract p-values
p_values <- pwt_result$p.value
print(p_values)

# Create data frame for manual p-value annotation
stat.test <- tibble::tribble(
  ~group1, ~group2,   ~p.adj,
  "1",     "2", round(p_values[1],6),
  "1",     "3", round(p_values[2],6),
  "1",     "4", round(p_values[3],6),
  "2",     "3", round(p_values[5],6),
  "2",     "4", round(p_values[6],6),
  "3",     "4", round(p_values[9],6))

# Determine the maximum value of the 'bmi' column
max_bmi <- max(framingham$bmi, na.rm = TRUE)

# Create an array of y positions starting from the maximum BMI value and incrementing by a small amount
y_positions <- max_bmi + seq(from = 1, to = 6, by = 1)

# Create boxplot
ggboxplot(framingham, x = "educ", y = "bmi",
          color = "educ", 
          palette = "jco") +
  stat_pvalue_manual(stat.test,
                     y.position = y_positions, 
                     step.increase = 0.2,
                     label = "p.adj")
```

i) Achten Sie auf eine "statistisch korrekte" Formulierung des Ergebnisses.

Der Wilcoxon Test liefert beim Faktor "Bildunsgrad" für die Vergleichspaare (1,2), (1,3) und (1,4) einen hochsignifikanten p-Wert kleiner 0.01.
D.h. der BMI der Gruppe mit Bildungsgrad 1 utnerscheidet sich signifikant von den anderen Bildungsgraden,
während der Unterschied zwischen den anderen Bildungsgraden (2,3), (2,4), (3,4) nicht signifikant ist.
Nimmt man an, dass die Gruppen aus Populationen mit annähernd derselben Verteilung entstammen, impliziert dies,
dass der Median der Gruppe mit Bildungsgrad 1 signifikant höher als der Median der anderen Gruppen ist.

# 4 Mehrfaktorielle ANOVA [2P]
Sie führen eine Studie bezüglich des Einflusses unterschiedlicher Diäten und Aktivitätslevels auf den Erfolg bei der Gewichtsabnahme durch. Jedem Probanden wird eine Diät und ein Aktivitätslevel zugewiesen und die Differenz zum Ausgangsgewicht nach 2 Monaten gemessen (in kg). Die Daten der Studie sind in `weightloss.sav` zusammengefasst. Analysieren Sie ob die beiden Faktoren einen Einfluss auf das Gewicht haben.

i) Überprüfen Sie die Vorraussetzungen.
i) Verwenden Sie eine geeignete grafische Darstellung der Daten / Ergebnisse.
i) Gibt es signifikante Haupteffekte sowie Interaktionseffekte (inkl. Interaktions-Plot)?
i) Achten Sie auf eine "statistisch korrekte" Formulierung des Ergebnisses.

```{r}
# Laden der Daten
library(foreign)
weightloss <- read.spss("UE3 Daten/weightloss.sav", to.data.frame = TRUE)

head(weightloss)
summary(weightloss)
attr(weightloss, "variable.labels")

# Hypothesen

# H0 (Diät): mu_noDiet = mu_vegetarian = mu_atkins
# H0 (Activität): mu_none = mu_30 = mu_60
# H0 (Interaktion): Alle Mittelwertunterschiede werden durch die Haupteffekte erklärt.
```
Nun werden die Vorraussetzungen für die ANOVA überprüft.

```{r}
# Überprüfen der Vorraussetzungen

# -- für Diet-Gruppen
unique_diets <- unique(weightloss$diet)

# Normalverteilung 
par(mfrow = c(1, 3))
for(diet in unique_diets) {
  # Daten für die spezifische Diät
  diet_data <- weightloss$wloss[weightloss$diet == diet]

  # Histogramm erstellen
  hist(diet_data, probability = TRUE,
       main = paste("Histogramm für Diät", diet),
       xlab = "Gewichtsabnahme (kg)",
       col = "gray", border = "black",
       ylim = c(0, 0.15))

  # Normalverteilungskurve hinzufügen
  curve(dnorm(x, mean = mean(diet_data), sd = sd(diet_data)), add = TRUE, col = "red")
}

# Shapiro-Wilk-Test
for (diet in unique_diets) {
  print(shapiro.test(weightloss$wloss[weightloss$diet == diet]))
}
```
```{r}
# -- für Activity-Gruppen
unique_activities <- unique(weightloss$exercise)

# Normalverteilung
par(mfrow = c(1, 3))
for(activity in unique_activities) {
  # Daten für die spezifische Aktivität
  activity_data <- weightloss$wloss[weightloss$exercise == activity]

  # Histogramm erstellen
  hist(activity_data, probability = TRUE,
       main = paste("Exercise:", activity),
       xlab = "Gewichtsabnahme (kg)",
       col = "gray", border = "black",
       ylim = c(0, 0.15))

  # Normalverteilungskurve hinzufügen
  curve(dnorm(x, mean = mean(activity_data), sd = sd(activity_data)), add = TRUE, col = "red")
}

# Shapiro-Wilk-Test
for (activity in unique_activities) {
  print(shapiro.test(weightloss$wloss[weightloss$exercise == activity]))
}
```
```{r}
# Varianzhomogenität (Heteroskedastizität)

# Levene-Test
leveneTest(wloss ~ diet, data = weightloss)
leveneTest(wloss ~ exercise, data = weightloss)
leveneTest(wloss ~ diet * exercise, data = weightloss)

# Bartlett-Test
bartlett.test(wloss ~ diet, data = weightloss)
bartlett.test(wloss ~ exercise, data = weightloss)

```

Die Überprüfung der Varianzhomogenität mittels Levene-Test und Bartlett-Test ergab keine signifikanten Unterschiede in den Varianzen zwischen den Diät- und Aktivitätsgruppen. Somit erfüllen die Daten die Voraussetzung der Varianzhomogenität für die Durchführung einer mehrfaktoriellen ANOVA. Es ist also statistisch angemessen, die Haupteffekte sowie den Interaktionseffekt der beiden Variablen zu analysieren.

```{r}
# Durchführung der ANOVA
summary(aov(wloss~diet+exercise,data=weightloss))

#mit Interaktionseffekte
summary(aov(wloss~diet*exercise,data=weightloss))
```

**Ergebnisse der ANOVA**

```{r}
# Boxplot (diets)
ggplot(weightloss, aes(x = diet, y = wloss)) +
  geom_boxplot() +
  labs(title = "Gewichtsabnahme in Abhängigkeit der Diät",
       x = "Diät",
       y = "Gewichtsabnahme (in kg)")

# Boxplot (activities)
ggplot(weightloss, aes(x = exercise, y = wloss)) +
  geom_boxplot() +
  labs(title = "Gewichtsabnahme in Abhängigkeit der Aktivität",
       x = "Aktivität",
       y = "Gewichtsabnahme (in kg)")

# Boxplot (diets & activities)
ggplot(weightloss, aes(x = diet, y = wloss, fill = exercise)) +
  geom_boxplot() +
  labs(title = "Gewichtsabnahme in Abhängigkeit der Diät und Aktivität",
       x = "Diät",
       y = "Gewichtsabnahme (in kg)",
       fill = "Aktivität")

# Ausreißer bereinigen (median +- 1.5 IQR)
library(dplyr)
weightloss_clean <- weightloss %>%
  group_by(diet, exercise) %>%
  mutate(lb = quantile(wloss, 0.25) - 1.5 * IQR(wloss),
         ub = quantile(wloss, 0.75) + 1.5 * IQR(wloss)) %>%
  filter(wloss >= lb & wloss <= ub)

# Boxplot (diets & activities)
ggplot(weightloss_clean, aes(x = diet, y = wloss, fill = exercise)) +
  geom_boxplot() +
  labs(title = "Gewichtsabnahme in Abhängigkeit der Diät und Aktivität (ausreißerbereinigt)",
       x = "Diät",
       y = "Gewichtsabnahme (in kg)",
       fill = "Aktivität")

```
i) Gibt es signifikante Haupteffekte sowie Interaktionseffekte (inkl. Interaktions-Plot)?

Der Faktor Diet (Df=2) hat einen deutlichen Einfluss auf die Gewichtsabnahme mit einem F-Wert von 21.124 und einem hochsignifikanten p-Wert (6.33e-09).

Das Bewegungsausmaß (Df=2) hatte einen noch stärkeren Einfluss auf die Gewichtsabnahme mit einem F-Wert von 87.589 und einem ebenfalls hochsignifikanten p-Wert (< 2e-16).

Die Interaktion zwischen Diät und Bewegung (Df = 4) war nicht signifikant mit einem F-Wert von 0.937 und einem p-Wert von 0.444. Dies bedeutet, dass die Wechselwirkung zwischen Diät und Bewegung keinen signifikanten Beitrag zur Erklärung der Gewichtsabnahme liefert.

```{r}
# Interaktionsplots (simple)
ip_act <- interaction.plot(weightloss$diet, weightloss$exercise, weightloss$wloss, 
                 col = c("darkorange", "darkgreen", "blue"),
                 pch = c(1, 2, 3), fixed = FALSE, xlab = "Diät", 
                 ylab = "Gewichtsabnahme (in kg)", trace.label = "Aktivität")

ip_diet <- interaction.plot(weightloss$exercise, weightloss$diet, weightloss$wloss, 
                 col = c("darkorange", "darkgreen", "blue"),
                 pch = c(1, 2, 3), fixed = FALSE, xlab = "Aktivität", 
                 ylab = "Gewichtsabnahme (in kg)", trace.label = "Diät")

```

```{r,message=FALSE}
# Interaktionsplot (ggpubr)
library(ggpubr)
ggline(weightloss, x = "diet", y = "wloss", color = "exercise", size = 1.1,
       add = c("mean_se","dotplot"))
ggline(weightloss, x = "exercise", y = "wloss", color = "diet", size = 1.1,
       add = c("mean_se","dotplot"))
```
Interaktionsplot 1: Dieser Plot zeigt die Gewichtsabnahme aufgeteilt nach Diättyp und gruppiert nach Aktivitätsniveau. Die drei Linien repräsentieren die unterschiedliche Aktivitätsniveaus. Auffallend ist hier, dass sich die Linien für keine Aktivität und die des mittleren Atktivitätsniveaus bei der Atkins-Diet kreuzen. Dies könnte auf eine leichte semidisordinale Interaktion, in diesem Fall hindeuten. Allerdings war die Interaktion in der ANOVA statistisch nicht signifikant (p = 0.444), somit ist diese visuell wahrgenommene Interaktion möglicherweise nicht stark genug ist, um statistisch statistische Signifikanz zu erreichen.

Interaktionsplot 2: Auf diesem Plot ist die Gewichtsabnahme aufgeteilt nach Aktivitätsniveau und gruppiert nach Diättyp. Die drei Linien repräsentieren die unterschiedlichen Diättypen. Die Linien zeigen sehr ähnliche Trends auf, und kreuzen sich nicht. Dies unterstützt das ANOVA-Ergebnis, dass keine signifikante Interaktion vorliegt.
Die Linie für "60 minutes per day" zeigt durchwegs die höchsten Werte, was die starke Wirkung eines erhöhten Aktivitätsniveau auf die Gewichtsabnahme unterstreicht, unabhängig von der gewählten Diät.

Um die Unterschiede zwischen den Gruppen genauer zu untersuchen, werden folglich Post-hoc-Tests durchgeführt. Hierfür eignen sich beispielsweise der Tukey's HSD-Test.

```{r}
# Post-hoc Tests
pht_diet <- TukeyHSD(aov(wloss~diet*exercise,data=weightloss),which="diet")
pht_act <- TukeyHSD(aov(wloss~diet*exercise,data=weightloss),which="exercise")
```

```{r}
# Darsellung der Post-hoc Test Ergebnisse
stat.test_diet <- tibble::tribble(
  ~group1, ~group2,   ~p.adj,
  "Atkins",     "None", round(pht_diet$diet[1,4],6),
  "Vegetarian",     "None", round(pht_diet$diet[2,4],6),
  "Vegetarian",     "Atkins", round(pht_diet$diet[3,4],6))

# Boxplot 
ggboxplot(weightloss, x = "diet", y = "wloss",
          fill = "diet", 
          palette = "Okabe-Ito",
          ylab = "weightloss") +
  stat_pvalue_manual(stat.test_diet,
                     y.position = 17, step.increase = 0.2,
                     label = "p.adj")

stat.test_act <- tibble::tribble(
  ~group1, ~group2,   ~p.adj,
  "30 minutes per day",     "None", round(pht_act$exercise[1,4],6),
  "60 minutes per day",     "None", round(pht_act$exercise[2,4],6),
  "60 minutes per day",     "30 minutes per day", round(pht_act$exercise[3,4],6))

# Boxplot
ggboxplot(weightloss, x = "exercise", y = "wloss",
          fill = "exercise", 
          palette = "Okabe-Ito",
          ylab = "weightloss") +
  stat_pvalue_manual(stat.test_act,
                     y.position = 12, step.increase = 0.2,
                     label = "p.adj")

```
Interpretation: 
Eine 2x3 ANOVA wurde durchgeführt, um den Einfluss unterschiedlicher Diäten (Keine, Atkins, Vegetarisch) und Aktivitätsniveaus (Keine, 30 min/Tag, 60 min/Tag) auf die Gewichtsabnahme zu untersuchen. Es wurde ein signifikanter Haupteffekt des Faktors Diät [F(2,171)=21.12,p < 0.01], als auch ein signifikanter Haupteffekt des Faktors Aktivitätsniveau [F(2,171)=87.59,p < 0.01] festgestellt werden. Es konnte kein signifikanter Interaktionseffekt zwischen Diät und Aktivitätsniveau nachgewiesen werden [F(4,171) = 0.937; p = 0.444]. 

Post-hoc-Tests Analysen zeigten signifikanten Unterschiede zwischen den einzelnen Diätgruppen und Aktivitätsniveaus. 

Personen, die eine vegetarische Diät befolgten, verloren durchschnittlich 3,47 kg mehr als jene ohne spezielle Diät und um 2 kg mehr als Personen, die der Atkins-Diät folgen. Diese Unterschiede sind statistisch signifikant, was die vegetarische Diät als besonders effektiv herausstellt. Die Atkins-Diät zeigt eine überlegene Wirkung im Vergleich zu keiner Diät mit einer signifikant höheren mittleren Gewichtsabnahme von 1,47 kg.

Die tägliche Dauer der körperlichen Aktivität spielt ebenfalls eine entscheidende Rolle bei der Gewichtsreduktion. Die Analyse ergab, dass 60 Minuten tägliche Bewegung zu einer signifikant höheren Gewichtsabnahme von 6,28 kg im Vergleich zu keiner Bewegung führte. Selbst im Vergleich zu 30 Minuten täglicher Aktivität ist das längere Training mit einer zusätzlichen Gewichtsabnahme von fast 6 kg deutlich effektiver. Im Gegensatz dazu zeigt die geringere Dauer von 30 Minuten keine signifikante Wirkung gegenüber keiner Bewegung.

# 5 Mehrfaktorielle ANOVA [2P]
Verwenden Sie den erneut den `Framingham.sav` Datensatz. Analysieren Sie den systolischen Blutdruck `sysbp` abhängig von Geschlecht und Bildungsstufe. Achten Sie auf Ausreißer und fehlende Daten (`NaN, NA's`).

i) Überprüfen Sie die Vorraussetzungen.

```{r}
load_source()

# Open a new graphics device
dev.new()

# Load and clean data. Handle factor variables
framingham <- load_and_prepare_framingham("UE3 Daten/Framingham.sav")

# Check requirements for ANOVA

# -- For education levels

test_normality_of_groups(framingham,"educ", "sysbp")

# -- For sex

test_normality_of_groups(framingham,"sex","sysbp")

# Variance inhomogeneity (Heteroscedasticity)

# Levene test
leveneTest(sysbp ~ educ, data = framingham)
leveneTest(sysbp ~ sex, data = framingham)
leveneTest(sysbp ~ educ * sex, data = framingham)

# Bartlett test
bartlett.test(sysbp ~ educ, data = framingham)
bartlett.test(sysbp ~ sex, data = framingham)
```

Die Histogramme der Blutdruck-Werte für die verschiedenen Bildungsstufen zeigen, dass die Verteilung der Blutdruck-Werte für jede Bildungsstufe nicht normal ist.
Der Shapiro-Wilk-Test bestätigt diese Annahme, da die p-Werte für alle Bildungsstufen kleiner als 0,05 sind.
Außerdem zeigt der Levene Test, dass die Varianz aller Gruppen nicht gleich ist. Dasselbe gilt für die Gruppen nach Geschlecht.
Daher sind die Voraussetzunge einer ANOVA verletzt. Allerdings reagiert der F-Test auf Abweichungen nicht so empfindlich, wenn
1) die Gruppengrößen etwa gleich sind
2) und die Gruppen hinreichend groß sind.

```{r}
table(framingham$educ)
table(framingham$sex)
```

Da Bedingung 1 nicht erfüllist, kommt keine zweifaktorielle ANOVA infrage.
Stattdessen wird für jeden Faktor ein Kruskal Wallis Test angewandt.
Für die Unterscuhung des Einflusses der Kombination von Geschlecht und Bildungsgrad wird ein Scheirer-Ray-Hare-Test durchgeführt.

i) Verwenden Sie eine geeignete grafische Darstellung der Daten / Ergebnisse.

```{r}
# Boxplot education levels
ggplot(framingham, aes(x = educ, y = sysbp)) +
  geom_boxplot() +
  labs(title = "Sys. Blutdruck in Abhängigkeit des Bildungsgrades",
       x = "Bildungsgrad",
       y = "Sys. Blutdruck in mmHg")

# Boxplot sexes
ggplot(framingham, aes(x = sex, y = sysbp)) +
  geom_boxplot() +
  labs(title = "Sys. Blutdruck in Abhängigkeit des Geschlechts",
       x = "Geschlecht",
       y = "Sys. Blutdruck in mmHg")

# Boxplot education levels & sexes
ggplot(framingham, aes(x = educ, y = sysbp, fill = sex)) +
  geom_boxplot() +
  labs(title = "Sys. Blutdruck in Abhängigkeit des Bildungsgrades und Geschlechts",
       x = "Bildungsgrad",
       y = "Sys. Blutdruck in mmHg",
       fill = "Geschlecht")

# Remove outliers (median +- 1.5 IQR)
library(dplyr)
framingham_clean <- framingham %>%
  group_by(educ, sex) %>%
  mutate(lb = quantile(sysbp, 0.25) - 1.5 * IQR(sysbp),
         ub = quantile(sysbp, 0.75) + 1.5 * IQR(sysbp)) %>%
  filter(sysbp >= lb & sysbp <= ub)


# Boxplot (diets & activities)
ggplot(framingham_clean, aes(x = educ, y = sysbp, fill = sex)) +
  geom_boxplot() +
  labs(title = "Sys. Blutdruck in Abhängigkeit des Bildungsgrades und Geschlechts",
       x = "Bildungsgrad",
       y = "Sys. Blutdruck in mmHg",
       fill = "Geschlecht")


```
Die visuelle Analyse legt die Vermutung nahe, dass Geschlecht und Bildungsgrad wechselwirken,
da die gedachten Verläufe durch die Mediane für Männer- und Frauengruppen sich zu überschneiden scheinen.

i) Gibt es signifikante Haupteffekte sowie Interaktionseffekte (inkl. Interaktions-Plot)?

```{r}
# Interaction plots (simple)
ip_educ <- interaction.plot(framingham$educ, framingham$sex, framingham$sysbp, 
                 col = c("darkorange", "darkgreen", "blue"),
                 pch = c(1, 2, 3), fixed = FALSE, xlab = "Bildungsgrad", 
                 ylab = "Sys. Blutdruck in mmHg", trace.label = "Geschlecht")

ip_sex <- interaction.plot(framingham$sex, framingham$educ, framingham$sysbp, 
                 col = c("darkorange", "darkgreen", "blue"),
                 pch = c(1, 2, 3), fixed = FALSE, xlab = "Geschlecht", 
                 ylab = "Sys. Blutdruck in mmHg", trace.label = "Bildungsgrad")

```
```{r,message=FALSE}
# Interaction plots (ggpubr)
ggline(framingham, x = "educ", y = "sysbp", color = "sex", size = 1.1,
       add = c("mean_se","dotplot"))
ggline(framingham, x = "sex", y = "sysbp", color = "educ", size = 1.1,
       add = c("mean_se","dotplot"))
```

Die Interaktionsplots zeigen, dass die Wechselwirkung disordinal ist, da es in beiden Plots (x-Achse: Bildungsgrad bzw. Geschlecht) Überschneidungen in den Verläufen durch die Gruppenmittelwerte gibt.

```{r}
# RESULTS NOT VALID! REQUIREMENTS NOT MET!

# # Post hoc tests
# pht_educ <- TukeyHSD(aov(sysbp~educ*sex,data=framingham),which="educ")
# pht_sex <- TukeyHSD(aov(sysbp~educ*sex,data=framingham),which="sex")
```


```{r}
# RESULTS NOT VALID! REQUIREMENTS NOT MET!

# # Show the post hoc test results
# stat.test_educ <- tibble::tribble(
#   ~group1, ~group2,   ~p.adj,
#   "1",     "2", round(pht$educ[1,4],6),
#   "1",     "3", round(pht$educ[2,4],6),
#   "1",     "4", round(pht$educ[3,4],6),
#   "2",     "3", round(pht$educ[4,4],6),
#   "2",     "4", round(pht$educ[5,4],6),
#   "3",     "4", round(pht$educ[6,4],6))

# # Determine the maximum value of the 'bmi' column
# max_sysbp <- max(framingham$sysbp, na.rm = TRUE)

# # Create an array of y positions starting from the maximum BMI value and incrementing by a small amount
# y_positions <- max_sysbp + seq(from = 1, to = 6, by = 1)

# # Boxplot 
# ggboxplot(framingham, x = "educ", y = "sysbp",
#           fill = "educ", 
#           palette = "Okabe-Ito",
#           ylab = "Sys. Blutdruck in mmHg") +
#   stat_pvalue_manual(stat.test_educ,
#                      y.position = y_positions,
#                      step.increase = 0.2,
#                      label = "p.adj")

# stat.test_sex <- tibble::tribble(
#   ~group1, ~group2,   ~p.adj,
#   "1",     "2", round(pht_sex$sex[1,4],6))


# # Boxplot
# ggboxplot(framingham, x = "sex", y = "sysbp",
#           fill = "sex", 
#           palette = "Okabe-Ito",
#           ylab = "Sys. Blutdruck in mmHg") +
#   stat_pvalue_manual(stat.test_sex,
#                      y.position = max_sysbp,
#                      label = "p.adj")

```

```{r}
# Perform Kruskal-Wallis test for educ
kruskal_educ <- kruskal.test(sysbp ~ educ, data = framingham)
kruskal_educ

# Post hoc tests

# Perform pairwise Wilcoxon tests
wilcox_educ <- pairwise.wilcox.test(framingham$sysbp, framingham$educ, p.adjust.method = "BH")

# Extract p-values
p_values_educ <- wilcox_educ$p.value

# Create data frames for manual p-value annotation
stat.test_educ <- tibble::tribble(
  ~group1, ~group2,   ~p.adj,
  "1",     "2", round(p_values_educ[1],6),
  "1",     "3", round(p_values_educ[2],6),
  "1",     "4", round(p_values_educ[3],6),
  "2",     "3", round(p_values_educ[5],6),
  "2",     "4", round(p_values_educ[6],6),
  "3",     "4", round(p_values_educ[9],6))

# Determine the maximum value of the 'sysbp' column
max_sysbp <- max(framingham$sysbp, na.rm = TRUE)

# Create an array of y positions starting from the maximum sysbp value and incrementing by a small amount
y_positions <- max_sysbp + seq(from = 1, to = 6, by = 1)

# Boxplot 
ggboxplot(framingham, x = "educ", y = "sysbp",
          fill = "educ", 
          palette = "Okabe-Ito",
          ylab = "Sys. Blutdruck in mmHg") +
  stat_pvalue_manual(stat.test_educ,
                     y.position = y_positions,
                     step.increase = 0.2,
                     label = "p.adj")
```

Der Kruskal Wallis Test zeigt, dass ein signfikanter Unterschied im BMI zwischen den Gruppen mit unterschiedlichem Bildungsgrad (1 bis 4) besteht (p Wert < 0.05).

Der Wilcoxon Test liefert beim Faktor "Bildunsgrad" (1 bis 4) für die Vergleichspaare (1,2), (1,3), (1,4) und (2,3) einen signifikanten p-Wert kleiner 0.05.
Nimmt man an, dass die Gruppen aus Populationen mit annähernd derselben Verteilung entstammen, impliziert dies,
dass der Median der Gruppe mit Bildungsgrad 1 signifikant höher als der Median der anderen Gruppen ist,
und dass der Median der Gruppe mit Bildungsgrad 2 signifikant höher als der Median der Gruppen 4 ist.


```{r}
# Perform Kruskal-Wallis test for sex
kruskal_sex <- kruskal.test(sysbp ~ sex, data = framingham)
kruskal_sex

# Post hoc tests

# Perform pairwise Wilcoxon tests
wilcox_sex <- pairwise.wilcox.test(framingham$sysbp, framingham$sex, p.adjust.method = "BH")

# Extract p-values
p_values_sex <- wilcox_sex$p.value

# Create data frames for manual p-value annotation
stat.test_sex <- tibble::tribble(
  ~group1, ~group2,   ~p.adj,
  "1",     "2", round(p_values_sex[1],6))

# Boxplot
ggboxplot(framingham, x = "sex", y = "sysbp",
          fill = "sex", 
          palette = "Okabe-Ito",
          ylab = "Sys. Blutdruck in mmHg") +
  stat_pvalue_manual(stat.test_sex,
                     y.position = max_sysbp,
                     label = "p.adj")
```

Der Kruskal Wallis Test zeigt keinen signifikanten Unterschied im Blutdruck zwischen Geschlecht Mann und Frau (p Wert > 0.05).
Der anschließende Wilcoxon Test bestätigt das Ergebnis.

```{r}
# Perform the Scheirer-Ray-Hare test to account for interactions
result <- scheirerRayHare(sysbp ~ educ + sex, data = framingham)

# Print the results
print(result)
```

i) Achten Sie auf eine "statistisch korrekte" Formulierung des Ergebnisses.

Der Scheirer-Ray-Hare-Test liefert einen signifikanten p-Wert (<0.05) für die Wechselwirkung zwischen Bildungsgrad und Geschlecht.
Dieses Ergebnis steht mit der Wechselwirkung, die im Interaktionsplot visuell dargestellt wurde, im Einklang.
Außerdem sind die p-Werte für die Haupteffekte (p-Wert für Bildungsgrad < 0.01, für Geschlecht: 0.163) des SRH Tests
kompatibel mit den p-Werten der Kruskal Wallis Tests der einzelnen Faktoren (p-Wert für Bildungsgrad < 0.01, für Geschlecht = 0.188). 




# [Bonus]

Analysieren Sie die erhobenen Daten bezüglich der Usability der LETHE App in der Kontroll- und
Interventionsgruppe. Betrachten Sie Kontroll- und Interventionsgruppe getrennt voneinander. Verwenden Sie
dazu die zur Verfügung gestellten .csv Dateien, wobei die Spalte „Score“ den SUS darstellt. Untersuchen Sie,
ob das jeweilige Land einen Einfluss auf die Usability der LETHE App hat. Verwenden Sie eine geeignete
grafische Darstellung der Daten und statistische Verfahren. Gibt es signifikante Unterschiede zwischen den
Ländern, wenn ja, zwischen welchen Ländern? Formulieren Sie die Ergebnisse „statistisch korrekt“.



```{r}
# Read in data

read_files <- function(directory) {
  # Get a list of all CSV files in the directory
  file_list <- list.files(directory, pattern = "*.csv", full.names = TRUE)
  
  # Initialize an empty data frame to store the results
  result <- data.frame()
  
  # Loop over the files
  for (file in file_list) {
    # Read the file into a data frame
    data <- read.csv(file)
    
    # Extract the group and country from the file name
    file_info <- strsplit(basename(file), "_")[[1]]
    group <- file_info[1]
    country <- file_info[3]
    
    # Keep only the 'Score' column and add the 'Group' and 'Country' columns
    data <- data.frame(Score = data$Score, Group = group, Country = country)
    
    # Append the data frame to the result
    result <- rbind(result, data)
  }
  
  return(result)
}

# Use the function to read the files from a directory
data_sus <- read_files("ue3_Bonus_LETHE_SUS/LETHE_SUS_data")

# Convert 'Group' and 'Country' to factors
data_sus$Group <- factor(data_sus$Group)
data_sus$Country <- factor(data_sus$Country)

# Print the updated data frame
data_sus
```

Alle .csv Dateien wwerden eingelesen. Das Dataframe enthält 3 Spalten "Score", "Group" und "Country". Die Spalten "Group" und "Country" werden in Faktoren umgewandelt.

```{r}
# Select subset of data by group type

# Subset the data for the Intervention group
intervention_data <- subset(data_sus, Group == "Intervention")

# Subset the data for the Control group
control_data <- subset(data_sus, Group == "Control")
```

Für die getrennte Analyse von Kontroll- und Interventionsgruppe werden die Daten entsprechend unterteilt.

```{r}
# Analyze Control Group

# -- For Whole Control Group

test_normality_of_groups(control_data,"Group", "Score")

# -- For Subgroup Countries in Control Group

test_normality_of_groups(control_data,"Country","Score")

# Variance inhomogeneity (Heteroscedasticity)

# Levene test
leveneTest(Score ~ Country, data = control_data)

# Bartlett test
bartlett.test(Score ~ Country, data = control_data)
```

Für die gesamte Kontrollgruppe gilt, dass die Normalverteilung der Scores nicht gegeben ist.
Dies wird durch den Shapiro-Wilk-Test bestätigt (p<0.05).
Ebenso liegt für die Subgruppen Östereich und Finnland keine Normalverteilung vor (p<0.05).
Die Varianz der Scores Über die Ländergruppen ist homogen, wie der Levene- und Bartlett-Test zeigen (p>0.05).
Da die Normalverteilung der Scores aller Ländergruppen nicht gegeben, ist eine Voraussetzung für die ANOVA verletzt.

```{r}
table(control_data$Country)
```
Zu wenige Daten bedeuten, dass eine ANOVA endgültig unzulässig ist. Es wird ein Kruskal Wallis Test angewandt.

```{r}
# Perform Kruskal-Wallis test for educ
kruskal_country <- kruskal.test(Score ~ Country, data = control_data)
kruskal_country

# Post hoc tests

# Perform pairwise Wilcoxon tests
wilcox_country <- pairwise.wilcox.test(control_data$Score, control_data$Country, p.adjust.method = "BH")


# Extract p-values
p_values_country <- wilcox_country$p.value

print(p_values_country)

# Convert p-value matrix to a vector
p_values_country_vec <- as.vector(p_values_country)

# Remove NA values (these are for comparisons with themselves)
p_values_country <- p_values_country_vec[!is.na(p_values_country_vec)]

# Create data frames for manual p-value annotation
stat.test_country <- tibble::tribble(
  ~group1, ~group2,   ~p.adj,
  "Austria",     "Finland", round(p_values_country[1],6),
  "Austria",     "Italy", round(p_values_country[2],6),
  "Austria",     "Sweden", round(p_values_country[3],6),
  "Finland",     "Italy", round(p_values_country[4],6),
  "Finland",     "Sweden", round(p_values_country[5],6),
  "Italy",     "Sweden", round(p_values_country[6],6))

p_values_country[8]

stat.test_country

# Determine the maximum value of the 'sysbp' column
max_score <- max(control_data$Score, na.rm = TRUE)

# Create an array of y positions starting from the maximum sysbp value and incrementing by a small amount
y_positions <- max_score + seq(from = 1, to = 6, by = 1)

y_positions
# Boxplot 
ggboxplot(control_data, x = "Country", y = "Score",
          fill = "Country", 
          palette = "Okabe-Ito",
          ylab = "Score (SUS)") +
  stat_pvalue_manual(stat.test_country,
                     y.position = y_positions,
                     step.increase = 0.2,
                     label = "p.adj")
```
Der Kruskal Wallis Test zeigt, dass es einen signifikanten Unterschied in der Usability der LETHE App zwischen den Ländern bei der Kontrollgruppe gibt (p<0.05).

Die Post hoc Analyse besagt, dass es innerhalb der Kontrollgruppe zwischen den Länder-Subgruppen keine signfikaten Unterschiede gibt
außer zwischen Österreich und Schweden (p<0.05). Dise bedeutet, dass sich die Verteilung des SUS Scores
zwischen den Ländern bei der Kontrollgruppe nicht signifikant unterscheidet außer zwischen Östereich und Schweden.

```{r}
# # Get the length of the p_values_country vector
# n <- length(p_values_country)

# # Loop over the indices from 1 to n
# for (i in 1:n) {
#   # Print the index and the corresponding p-value
#   print(paste("Index:", i, "P-value:", round(p_values_country[i], 6)))
# }
```


```{r}
# Analyze Intervention Group

# -- For Whole Intervention Group

test_normality_of_groups(intervention_data,"Group", "Score")

# -- For Subgroup Countries in Intervention Group

test_normality_of_groups(intervention_data,"Country","Score")

# Variance inhomogeneity (Heteroscedasticity)

# Levene test
leveneTest(Score ~ Country, data = intervention_data)

# Bartlett test
bartlett.test(Score ~ Country, data = intervention_data)
```

Für die gesamte Interventionsgruppe gilt, dass die Normalverteilung der Scores nicht gegeben ist.
Dies wird durch den Shapiro-Wilk-Test bestätigt (p<0.05).
Ebenso liegt für die Subgruppe Östereich keine Normalverteilung vor (p<0.05).
Die Varianz der Scores Über die Ländergruppen ist homogen, wie der Levene- und Bartlett-Test zeigen (p>0.05).
Da die Normalverteilung der Scores aller Ländergruppen nicht gegeben, ist eine Voraussetzung für die ANOVA verletzt.

```{r}
table(intervention_data$Country)
```
Zu wenige Daten bedeuten, dass eine ANOVA endgültig unzulässig ist. Es wird ein Kruskal Wallis Test angewandt.

```{r}
# Perform Kruskal-Wallis test for educ
kruskal_country <- kruskal.test(Score ~ Country, data = intervention_data)
kruskal_country

# Post hoc tests

# Perform pairwise Wilcoxon tests
wilcox_country <- pairwise.wilcox.test(intervention_data$Score, intervention_data$Country, p.adjust.method = "BH")


# Extract p-values
p_values_country <- wilcox_country$p.value

print(p_values_country)

# Convert p-value matrix to a vector
p_values_country_vec <- as.vector(p_values_country)

# Remove NA values (these are for comparisons with themselves)
p_values_country <- p_values_country_vec[!is.na(p_values_country_vec)]

# Create data frames for manual p-value annotation
stat.test_country <- tibble::tribble(
  ~group1, ~group2,   ~p.adj,
  "Austria",     "Finland", round(p_values_country[1],6),
  "Austria",     "Italy", round(p_values_country[2],6),
  "Austria",     "Sweden", round(p_values_country[3],6),
  "Finland",     "Italy", round(p_values_country[4],6),
  "Finland",     "Sweden", round(p_values_country[5],6),
  "Italy",     "Sweden", round(p_values_country[6],6))

p_values_country[8]

stat.test_country

# Determine the maximum value of the 'sysbp' column
max_score <- max(intervention_data$Score, na.rm = TRUE)

# Create an array of y positions starting from the maximum sysbp value and incrementing by a small amount
y_positions <- max_score + seq(from = 1, to = 6, by = 1)

y_positions
# Boxplot 
ggboxplot(intervention_data, x = "Country", y = "Score",
          fill = "Country", 
          palette = "Okabe-Ito",
          ylab = "Score (SUS)") +
  stat_pvalue_manual(stat.test_country,
                     y.position = y_positions,
                     step.increase = 0.2,
                     label = "p.adj")
```

Der Kruskal Wallis Test zeigt, dass es KEINEN signifikanten Unterschied in der Usability der LETHE App zwischen den Ländern bei der Interventionsgruppe gibt (p<0.05).

Die Post hoc Analyse bestätigt, dass es innerhalb der Interventionsgruppe zwischen den Länder-Subgruppen keine signfikaten Unterschiede gibt (p<0.05).
Dise bedeutet, dass sich die Verteilung des SUS Scores zwischen den Ländern bei der Interventionsgruppe nicht signifikant unterscheidet.

```{r}
# Create Boxplots for Control Group vs. Intervention Group

# Boxplot country levels
ggplot(data_sus, aes(x = Country, y = Score)) +
  geom_boxplot() +
  labs(title = "SUS in Abhängigkeit des Landes",
       x = "Land",
       y = "Score (SUS)")

# Boxplot group levels
ggplot(data_sus, aes(x = Group, y = Score)) +
  geom_boxplot() +
  labs(title = "SUS in Abhängigkeit der Gruppe",
       x = "Gruppe",
       y = "Score (SUS)")

# Boxplot country and group levels with mean lines
ggplot(data_sus, aes(x = Country, y = Score, fill = Group)) +
  geom_boxplot(position = position_dodge(0.9)) +
  stat_summary(
    fun = mean,
    geom = "crossbar",
    width = 0.7,
    position = position_dodge(0.9),
    color = "red",
    size = 0.5,
    linetype = "11"
    ) +
  annotate(
    "text",
    x = Inf,
    y = Inf,
    label = "Gepunktete Linie <- Mittelwert",
    hjust = 1,
    vjust = 1
  ) +
  labs(
    title = "SUS in Abhängigkeit des Landes und der Gruppe",
    x = "Land",
    y = "Score (SUS)",
    fill = "Gruppe"
  ) +
  ylim(min(data_sus$Score), max(data_sus$Score))
```

```{r}
# Remove outliers (median +- 1.5 IQR)
library(dplyr)
data_sus_clean <- data_sus %>%
  group_by(Country, Group) %>%
  mutate(lb = quantile(Score, 0.25) - 1.5 * IQR(Score),
         ub = quantile(Score, 0.75) + 1.5 * IQR(Score)) %>%
  filter(Score >= lb & Score <= ub)


# Boxplot country and group levels with mean lines
ggplot(data_sus_clean, aes(x = Country, y = Score, fill = Group)) +
  geom_boxplot(position = position_dodge(0.9)) +
  stat_summary(
    fun = mean,
    geom = "crossbar",
    width = 0.7,
    position = position_dodge(0.9),
    color = "red",
    size = 0.5,
    linetype = "11"
    ) +
  annotate(
    "text",
    x = Inf,
    y = Inf,
    label = "Gepunktete Linie <- Mittelwert",
    hjust = 1,
    vjust = 1
  ) +
  labs(
    title = "SUS in Abhängigkeit des Landes und der Gruppe",
    x = "Land",
    y = "Score (SUS)",
    fill = "Gruppe"
  ) +
  ylim(min(data_sus$Score), max(data_sus$Score))
```

Die von Ausreißern bereinigten Boxplots zeigen, variierende Verhältnisse zwischen Kontroll- und Interventionsgruppe in den Ländern.
Für Östereich und Italien fällt der Median der Kontrollgruppe höher aus als der der Interventionsgruppe.
Für Finnland fällt der Median der Interventionsgruppe höher aus als der der Kontrollgruppe.
Für Schweden gibt es nur einen minimalen Unterschied zwischen den Medianen der Kontroll- und Interventionsgruppe.

```{r}
# load_source()

# # -- For education levels

# test_normality_of_groups(data_sus,"Group", "Score")

# # -- For sex

# test_normality_of_groups(data_sus,"Country","Score")

# # Variance inhomogeneity (Heteroscedasticity)

# # Levene test
# leveneTest(Score ~ Group, data = data_sus)
# leveneTest(Score ~ Country, data = data_sus)
# leveneTest(Score ~ Group * Country, data = data_sus)

# # Bartlett test
# bartlett.test(Score ~ Group, data = data_sus)
# bartlett.test(Score ~ Country, data = data_sus)
```

```{r}
data_sus <- data_sus_clean

# Interaction plots (simple)
ip_educ <- interaction.plot(data_sus$Country, data_sus$Group, data_sus$Score, 
                 col = c("darkorange", "darkgreen", "blue"),
                 pch = c(1, 2, 3), fixed = FALSE, xlab = "Country", 
                 ylab = "Score (SUS)", trace.label = "Group")

ip_sex <- interaction.plot(data_sus$Group, data_sus$Country, data_sus$Score, 
                 col = c("darkorange", "darkgreen", "blue"),
                 pch = c(1, 2, 3), fixed = FALSE, xlab = "Group", 
                 ylab = "Score (SUS)", trace.label = "Country")

```

```{r,message=FALSE}
# Interaction plots (ggpubr)
ggline(data_sus, x = "Country", y = "Score", color = "Group", size = 1.1,
       add = c("mean_se","dotplot"))
ggline(data_sus, x = "Group", y = "Score", color = "Country", size = 1.1,
       add = c("mean_se","dotplot"))
```

Die Interaktionsplots zeigen für die Ausreißer bereinigten Daten, dass die Wechselwirkung semidisordinal ist.
Beim Ländervergleich auf der x-Achse überschneiden sich die Verläufe für Kontroll- und Interventionsgruppe.
Beim Gruppenvergleich auf der x-Achse gibt es keine Überschneidungen, aber negative wie positive Steigungen der Verdünnungslinien.