---
title: "Vertiefende statistische Verfahren"
subtitle: "3. Übungsblatt SS 2024"
author:
- 
- 
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
---

# Allgemeine Information
Alle Aufgaben sind mit R zu lössen, wenn nicht explizit anders angegeben. Die Berechnungen sollen nachvollziehbar und dokumentiert sein. Um die vollständige Punktezahl zu erreichen, müssen alle Ergebnisse und Fragen entsprechend interpretiert bzw. beantwortet werden. Code alleine ist nicht ausreichend! Die Abgabe erfolgt über Moodle entsprechend der Abgaberichtlinien als pdf und Rmd File. Bitte inkludieren Sie namentlich alle beteiligten Gruppenmitglieder sowohl im Bericht als auch im Source Code.
Die jeweiligen Datensätze die für diese Übung relevant sind finden Sie ebenfalls in Moodle.


# 1 Einfaktorielle ANOVA (händisch) [2P]
Ein Sportwissenschafter möchte sehen, ob es einen Unterschied in der Gewichtszunahme von Sportlern gibt, die einer von drei speziellen Diäten folgen. Die Athleten werden nach dem Zufallsprinzip drei Gruppen zugewiesen und unterziehen sich für 6 Wochen der jeweiligen Diät. Die Gewichtszunahmen (in Pfund) sind angegeben. Nehmen Sie an, dass die Gewichtszunahmen normalverteilt sind und die Varianzen gleich sind. Kann der Sportwissenschafter bei einem Signifikanzniveau von 0,05 schlussfolgern, dass es einen Unterschied zwischen den Diäten gibt? Führen Sie die ANOVA händisch durch und überprüfen Sie das Ergebnis mit `summary(aov(...))`.

Diät   | Messwerte
-------| -------------
A      | 3, 6, 7, 4       
B      | 10, 12, 11, 14, 8, 6
C      | 8, 3, 2, 5

```{r}
# ANOVA händische durchführung
gains <- list(
  A = c(3, 6, 7, 4),
  B = c(10, 12, 11, 14, 8, 6),
  C = c(8, 3, 2, 5))

# Überblick über die Daten / Farben nach Diet
str(gains)
boxplot(gains, col = c("red", "green", "blue"), 
        ylab = "Gewichtszunahmen",
        xlab = "Diät",
        main = "Gewichtszunahmen nach Diät")

# Hypothesen
# H0: mu_a = mu_b = mu_c
# H1: mu_i != mu_j (für mindestens ein Paar i,j)

# Berechnung der Mittelwerte
mean_total = mean(unlist(gains))

# Berechnung der Quadratsummen
qs_between <- 0
for (group in gains) {
  group_mean <- mean(group)
  n <- length(group)
  qs_between <- qs_between + n * (group_mean - mean_total)^2
}

qs_within <- 0
for (group in gains) {
  group_mean <- mean(group)
  for (value in group) {
    qs_within <- qs_within + (value - group_mean)^2
  }
}

qs_total <- sum((unlist(gains) - mean_total)^2)

# Prüfung der Quadratsummen
round(qs_total, 2)==round(qs_between + qs_within, 2)

# Überprüfen der Vorraussetzungen

# Normalverteilung
for (group in gains) {
  print(shapiro.test(group))
}

# Varianzhomogenität (Barlet-Test)
bartlett.test(gains)

# Freiheitsgrade
df_between <- length(gains) - 1
df_within <- length(unlist(gains)) - length(gains)
df_total <- length(unlist(gains)) - 1

# Berechnung der Varianzen (Mittlere Quadratsummen)
ms_total <- qs_total / df_total
ms_between <- qs_between / df_between
ms_within <- qs_within / df_within

# Berechnung des F-Wertes
f_value <- ms_between / ms_within

# kritischer F-Wert aus Tabelle
alpha <- 0.05
f_critical <- qf(1 - alpha, df_between, df_within,lower.tail = F)

# Ergebnis
if (f_value > f_critical) {
  print("H0 wird verworfen")
} else {
  print("H0 wird nicht verworfen")
}

# p-Wert
p_value <- pf(f_value, df_between, df_within, lower.tail = F)

# Überprüfung mit R
diet <- factor(rep(names(gains), times = sapply(gains, length)))
all_gains <- unlist(gains)

aov_result <- aov(all_gains ~ diet)
summary(aov_result)

# Effektgröße
eta_squared <- qs_between / qs_total

```

Interpretation: Es gibt einen signifikanten Einfluss des Faktors Diät, F(2,11) = 7.74; p < 0.05. Als Effektgröße wurde ein Eta-Quadrat von 0.58 berechnet. Das Eta-Quadrat schätzt den Anteil der Varianz, der durch den eine Variable erklärt wird. Jedoch ist der Literatur zu entnehmen, dass der Einfluss in der Varianz durch diese Maßzahl meist überschätzt wird.

# 2 Einfaktorielle ANOVA [2P]
Analysieren Sie die Daten zu niedrigem Geburtsgewicht von Neugeborenen in `birthwt_aov.xlsx`. Untersuchen Sie ob die ethnische Zugehörigkeit der Mutter (Variable `ethnic`, wobei `1 = "white"`, `2 = "black"`, `3 = "other"` ) einen Einfluss auf das Geburtsgewicht von Neugeborenen hat (Variable `bwt`). Beachten Sie dabei folgende Punkte:

i) Überprüfen Sie die Vorraussetzungen.
i) Verwenden Sie eine geeignete grafische Darstellung der Daten / Ergebnisse.
i) Gibt es signifikante Unterschiede zwischen den Gruppen, wenn ja zwischen welchen Gruppen?
i) Achten Sie auf eine "statistisch korrekte" Formulierung des Ergebnisses.

```{r}
# Daten einlesen
library(readxl)
birthwt <- read_excel("UE3 Daten/birthwt_aov.xlsx")

# Überblick über die Daten
str(birthwt)
summary(birthwt$bwt)

# Hypothesen
# H0: mu_white = mu_black = mu_other
# H1: mu_i != mu_j (für mindestens ein Paar i,j)

# Überprüfen der Vorraussetzungen

# Normalverteilung (für jede Gruppe)
par(mfrow = c(1,3))
hist(birthwt$bwt[birthwt$ethnic == 1], main = "ehnic 1 (white)")
hist(birthwt$bwt[birthwt$ethnic == 2], main = "ehnic 2 (black)")
hist(birthwt$bwt[birthwt$ethnic == 3], main = "ehnic 3 (other)")

# Shapiro-Wilk-Test
for (group in 1:3) {
  print(shapiro.test(birthwt$bwt[birthwt$ethnic == group]))
}
```
Ein visuelle Überprüfung der Normalverteilung zeigt, dass diese für alle Gruppen gegeben ist. Der Shapiro-Wilk-Test bestätigt diese Annahme, weshalb die Normalverteilung als gegeben angenommen werden kann

```{r}
# Varianzhomogenität

# Levene-Test
library(car)
leveneTest(bwt ~ as.factor(ethnic), data = birthwt)

# Bartlett-Test
bartlett.test(birthwt$bwt ~ as.factor(birthwt$ethnic))

```
Sowohl der Levene- als auch der Bartlett-Test zeigen, dass die Varianzhomogenität gegeben ist. 

Die Vorraussetzungen für die ANOVA sind somit gegeben und sie kann ohne Bedenken durchgeführt werden.


```{r}
# ANOVA
aov_result <- aov(bwt ~ as.factor(ethnic), data = birthwt)
summary(aov_result)

# Darstellung der Ergebnisse
library(ggplot2)
ggplot(birthwt, aes(x = as.factor(ethnic), y = bwt)) +
  geom_boxplot() +
  labs(title = "Geburtsgewicht in Abhängigkeit der ethnischen Zugehörigkeit",
       x = "ethnische Zugehörigkeit",
       y = "Geburtsgewicht")

```
F_value = 4.91, p = 0.008 (p < 0.05) -> H0 wird verworfen

Die ethnische Zugehörigkeit hat einen signifikanten Einfluss auf das Geburtsgewicht von Neugeborenen, F(2,186)=4.91, p = 0.008.

Um herauszufinden zwischen welchen Gruppen die Unterschiede bestehen, wird nun ein Post-Hoc-Test durchgeführt. Als geeigneter Test wird der Tukey HSD-Test verwendet.

```{r}
# Post-Hoc-Test
pht <- TukeyHSD(aov_result)
print(pht)

# Darstellung der Ergebnisse
library(ggpubr)

stat.test <- tibble::tribble(
  ~group1, ~group2,   ~p.adj,
  "White",     "Black", round(pht$`as.factor(ethnic)`[1,4],6),
  "White",     "Other", round(pht$`as.factor(ethnic)`[2,4],6),
  "Black",     "Other", round(pht$`as.factor(ethnic)`[3,4],6))

# Boxplot erstellen
ggboxplot(birthwt, x = "ethnic", y = "bwt", fill = "ethnic" 
          add = "jitter", 
          color = "ethnic", 
          palette = "jco") +
  stat_pvalue_manual(stat.test,
                     y.position = 75, step.increase = 0.2,
                     label = "p.adj")

# Boxplot erstellen
ggboxplot(birthwt, x = "ethnic", y = "bwt",
          add = "jitter",
          color = "ethnic", 
          palette = "jco") +
  stat_pvalue_manual(stat.test,
                     y.position = 75, step.increase = 0.2,
                     label = "p.adj")


```

# 3 Einfaktorielle ANOVA [2P]

Verwenden Sie den bereits bekannten `Framingham.sav` Datensatz. Analysieren Sie ob es Unterschiede im BMI in Abhängigkeit von der Schulbildung gibt. Achten Sie auf Ausreißer und fehlende Daten (`NaN, NA's`).

i) Überprüfen Sie die Vorraussetzungen.
i) Verwenden Sie eine geeignete grafische Darstellung der Daten / Ergebnisse.
i) Gibt es signifikante Unterschiede zwischen den Bildungsstufen, wenn ja zwischen welchen Stufen?
i) Achten Sie auf eine "statistisch korrekte" Formulierung des Ergebnisses.

# 4 Mehrfaktorielle ANOVA [2P]
Sie führen eine Studie bezüglich des Einflusses unterschiedlicher Diäten und Aktivitätslevels auf den Erfolg bei der Gewichtsabnahme durch. Jedem Probanden wird eine Diät und ein Aktivitätslevel zugewiesen und die Differenz zum Ausgangsgewicht nach 2 Monaten gemessen (in kg). Die Daten der Studie sind in `weightloss.sav` zusammengefasst. Analysieren Sie ob die beiden Faktoren einen Einfluss auf das Gewicht haben.

i) Überprüfen Sie die Vorraussetzungen.
i) Verwenden Sie eine geeignete grafische Darstellung der Daten / Ergebnisse.
i) Gibt es signifikante Haupteffekte sowie Interaktionseffekte (inkl. Interaktions-Plot)?
i) Achten Sie auf eine "statistisch korrekte" Formulierung des Ergebnisses.

# 5 Mehrfaktorielle ANOVA [2P]
Verwenden Sie den erneut den `Framingham.sav` Datensatz. Analysieren Sie den systolischen Blutdruck `sysbp` abhängig von Geschlecht und Bildungsstufe. Achten Sie auf Ausreißer und fehlende Daten (`NaN, NA's`).

i) Überprüfen Sie die Vorraussetzungen.
i) Verwenden Sie eine geeignete grafische Darstellung der Daten / Ergebnisse.
i) Gibt es signifikante Haupteffekte sowie Interaktionseffekte (inkl. Interaktions-Plot)?
i) Achten Sie auf eine "statistisch korrekte" Formulierung des Ergebnisses.
